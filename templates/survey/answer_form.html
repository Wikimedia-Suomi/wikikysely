{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% translate 'Answer question' %}{% endblock %}
{% block content %}
<div class="card mx-auto mb-4" style="max-width: 40rem;" data-question-id="{{ question.pk }}">
  <div id="answerbox" class="card-body text-center">
    <h2 class="card-title mb-0" style="padding-bottom:0.25em;">{{ question.text }}</h2>
{% if request.user.is_authenticated %}
<form method="post" action="{% url 'survey:answer_question' question.pk %}" class="text-center ajax-answer-question" id="answer-form" data-is-edit="{{ is_edit|yesno:'true,false' }}">
  {% csrf_token %}
  {% if next %}
  <input type="hidden" name="next" value="{{ next }}">
  {% endif %}
  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}
  {% for field in form.hidden_fields %}
    {{ field }}
  {% endfor %}
      <div style='float:right;vertical-align:middle;line-height:2.5em'><a href="{% url 'survey:answer_question' question.pk %}">#{{ question.pk }}</a></div>

  <div class="answer-buttons mb-2" role="group" aria-label="{% translate 'Answer' %}">

    <div class="btn-group yes-no-group me-2" role="group">
      <button type="submit" name="answer" value="yes"
              class="btn {% if form.answer.value and is_edit %}{% if form.answer.value == 'yes' %}btn-success{% else %}btn-outline-success{% endif %}{% else %}btn-success{% endif %}">{% translate 'Yes' %}</button>
      <button type="submit" name="answer" value="no"
              class="btn {% if form.answer.value and is_edit %}{% if form.answer.value == 'no' %}btn-danger{% else %}btn-outline-danger{% endif %}{% else %}btn-danger{% endif %}">{% translate 'No' %}</button>
    </div>
    {% if is_edit %}
      {% if survey.state == 'running' %}
      <a href="{% url 'survey:answer_delete' form.instance.pk %}?next={{ next|urlencode }}" class="btn btn-danger me-2" data-question-id="{{ question.pk }}">{% translate 'Remove answer' %}</a>
      {% endif %}
      {% if can_delete_question %}
      <a href="{% url 'survey:question_delete' question.pk %}?next={{ next|urlencode }}" class="btn btn-danger">{% translate 'Remove question' %}</a>
      {% endif %}
    {% else %}
      <button type="submit" name="answer" value="" class="btn btn-secondary">{% translate 'Skip' %}</button>
    {% endif %}

  </div>

</form>
{% endif %}
  </div>
</div>
{% for q in unanswered_questions %}
<div class="card mx-auto mb-4 unanswered-card" style="max-width: 40rem;" data-question-id="{{ q.pk }}">
  <div class="card-body text-center">
    <h2 class="card-title mb-0" style="padding-bottom:0.25em;">{{ q.text }}</h2>
    {% if request.user.is_authenticated %}
    <form method="post" action="{% url 'survey:answer_question' q.pk %}" class="text-center ajax-answer-question" data-is-edit="false">
      {% csrf_token %}
      <input type="hidden" name="question_id" value="{{ q.pk }}">
      {% if next %}<input type="hidden" name="next" value="{{ next }}">{% endif %}
      <div style='float:right;vertical-align:middle;line-height:2.5em'><a href="{% url 'survey:answer_question' q.pk %}">#{{ q.pk }}</a></div>
      <div class="answer-buttons mb-2" role="group" aria-label="{% translate 'Answer' %}">
        <div class="btn-group yes-no-group me-2" role="group">
          <button type="submit" name="answer" value="yes" class="btn btn-success">{% translate 'Yes' %}</button>
          <button type="submit" name="answer" value="no" class="btn btn-danger">{% translate 'No' %}</button>
        </div>
        <button type="submit" name="answer" value="" class="btn btn-secondary">{% translate 'Skip' %}</button>
      </div>
    </form>
    {% endif %}
  </div>
</div>
{% endfor %}
{% url 'survey:question_add' as question_add_url %}
{% blocktrans trimmed with question_add_url=question_add_url asvar skip_help_message %}
If the question was poorly worded, you can <a href="{{ question_add_url }}">add</a> a new question on the same topic even if it differs only slightly. Different perspectives on the same topics help make more reasoned interpretations of the response data.
{% endblocktrans %}
<div id="skip-help-message" class="card-footer skip-help-container"{% if not show_skip_help %} style="display:none"{% endif %}>
  <p class="fst-italic mb-0">
    <span class="skip-help-label">{% translate 'Tip:' %}</span>
    <span class="skip-help-text">{{ skip_help_message|safe }}</span>
  </p>
</div>
<div id="thanks-message" class="card-footer skip-help-container"{% if not show_thanks_message %} style="display:none"{% endif %}>
  <p class="fst-italic mb-0">
    <span class="skip-help-text">{% translate "Thank you in advance for each of your answers. You can stop whenever you like, as questions are shown in random order." %}</span>
  </p>
</div>

{% if question_stats %}
  <h2 class="mt-4">
    <a class="text-decoration-none collapse-toggle collapsed" data-bs-toggle="collapse" href="#answerDetails" role="button" aria-expanded="false" aria-controls="answerDetails">{% translate 'Answer details' %}</a>
  </h2>
  <div id="answerDetails" class="collapse">
  <!--div class="row mb-4">
    <div class="col-md-6 text-center">
      <p class="mt-2">{% translate 'Answer distribution' %}</p>
      <canvas id="answerPieChart"></canvas>
    </div>
    <div class="col-md-6 text-center">
      <p class="mt-2">{% translate 'Answers over time' %}</p>
      <canvas id="answerTimelineChart"></canvas>
    </div>
  </div-->
  <div class="table-responsive">
  <table class="table mb-3 stacked-table">
    <thead>
      <tr>
        <th>{% translate 'ID' %}</th>
        <th>{% translate 'Published' %}</th>
        <th>{% translate 'Yes' %}</th>
        <th>{% translate 'No' %}</th>
        <th>{% translate 'Total' %}</th>
        <th>{% translate 'Agree' %}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td data-label="{% translate 'ID' %}">{{ question.pk }}</td>
        <td data-label="{% translate 'Published' %}">{{ question_stats.published|date:"Y-m-d" }}</td>
        <td data-label="{% translate 'Yes' %}">{{ question_stats.yes }}</td>
        <td data-label="{% translate 'No' %}">{{ question_stats.no }}</td>
        <td data-label="{% translate 'Total' %}">{{ question_stats.total }}</td>
        <td data-label="{% translate 'Agree' %}">{{ question_stats.agree_ratio|floatformat:1 }}%</td>
      </tr>
    </tbody>
  </table>
  </div>
  </div>
{% endif %}
{% if request.user.is_authenticated %}
  <h2 id="my-answers-header" class="mt-4"{% if not user_answers %} style="display:none"{% endif %}>
    <a class="text-decoration-none collapse-toggle collapsed" data-bs-toggle="collapse" href="#myAnswers" role="button" aria-expanded="false" aria-controls="myAnswers">{% translate 'My answers' %}</a>
  </h2>
  <div id="myAnswers" class="collapse"{% if not user_answers %} style="display:none"{% endif %}>
  <div class="table-responsive">
  <table id="my-answers-table" class="table mb-3 survey-detail-table stacked-table"{% if not user_answers %} style="display:none"{% endif %}>
    <thead>
      <tr>
        <th>{% translate 'Answer date' %}</th>
        <!--th>{% translate 'ID' %}</th-->
        <th>{% translate 'Title' %}</th>
        <th>{% translate 'Answers' %}</th>
        <th>{% translate 'Agree' %}</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="my-answers-body">
      {% if user_answers %}
      {% for a in user_answers %}
      <tr data-question-id="{{ a.question.pk }}">
        <td data-label="{% translate 'Answer date' %}">{{ a.created_at|date:"Y-m-d" }}</td>
        <!--td data-label="{% translate 'ID' %}">{{ a.question.pk }}</td-->
        <td data-label="{% translate 'Title' %}"><a href="{% url 'survey:answer_question' a.question.pk %}">{{ a.question.text }}</a></td>
        <td class="total-answers" data-label="{% translate 'Answers' %}">{{ a.total_answers }}</td>
        <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ a.agree_ratio|floatformat:1 }}%</td>
        <td class="text-end" data-label="">
          {% if a.question.survey.state == 'running' %}
          <form method="post" action="{% url 'survey:answer_edit' a.pk %}" class="d-inline ajax-answer-form">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ a.question.pk }}">
            <div class="btn-group yes-no-group" role="group" aria-label="{% translate 'Answer' %}">
              <input type="radio" class="btn-check" name="answer" id="answer-{{ a.pk }}-yes" value="yes"{% if a.answer == 'yes' %} checked{% endif %}>
              <label class="btn btn-sm btn-outline-success" for="answer-{{ a.pk }}-yes">{% translate 'Yes' %}</label>
              <input type="radio" class="btn-check" name="answer" id="answer-{{ a.pk }}-no" value="no"{% if a.answer == 'no' %} checked{% endif %}>
              <label class="btn btn-sm btn-outline-danger" for="answer-{{ a.pk }}-no">{% translate 'No' %}</label>
            </div>
          </form>
          <a href="{% url 'survey:answer_delete' a.pk %}" class="btn btn-sm btn-danger ms-2 ajax-delete-answer" data-question-id="{{ a.question.pk }}" data-no-reload="true">{% translate 'Remove answer' %}</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="no-answers-placeholder">
        <td colspan="5">{% translate 'No answers' %}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
  </div>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{% static 'js/sort_tables.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    initSortableTables(".survey-detail-table", 1);
});
</script>
<script>
const yesLabel = '{{ yes_label|escapejs }}';
const noLabel = '{{ no_label|escapejs }}';
const noAnswersLabel = '{{ no_answers_label|escapejs }}';
const answerDateLabel = '{{ _("Answer date")|escapejs }}';
const titleLabel = '{{ _("Title")|escapejs }}';
const answersLabel = '{{ _("Answers")|escapejs }}';
const agreeLabel = '{{ _("Agree")|escapejs }}';
const answerLabel = '{{ _("Answer")|escapejs }}';
const removeAnswerLabel = '{{ _("Remove answer")|escapejs }}';
const completionUrl = "{% url 'survey:completion' %}";
const successColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-success').trim() || 'green';
const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-danger').trim() || 'red';
const placeholderColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-secondary-bg').trim() ||
    getComputedStyle(document.documentElement).getPropertyValue('--bs-secondary').trim() || 'gray';
const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-primary').trim() || 'blue';
const yesCount = {{ question_stats.yes|default:0 }};
const noCount = {{ question_stats.no|default:0 }};
const totalCount = {{ question_stats.total|default:0 }};
const maxTotal = {{ max_total|default:0 }};
const pieCtx = document.getElementById('answerPieChart');
if (pieCtx) {
    const maxPieSize = 200;
    const placeholderSize = 100;
    const size = totalCount === 0 ? placeholderSize :
        maxPieSize * Math.sqrt(totalCount / Math.max(maxTotal, 1));
    pieCtx.width = size;
    pieCtx.height = size;
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: totalCount === 0 ? [noAnswersLabel] : [yesLabel, noLabel],
            datasets: [{
                data: totalCount === 0 ? [1] : [yesCount, noCount],
                backgroundColor: totalCount === 0 ? [placeholderColor] : [successColor, dangerColor]
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}

const timelineData = {{ timeline_data|safe }};
const tlCtx = document.getElementById('answerTimelineChart');
if (tlCtx) {
    new Chart(tlCtx, {
        type: 'bar',
        data: {
            labels: timelineData.map(d => d.date),
            datasets: [{
                label: '{{ Answers|escapejs }}',
                data: timelineData.map(d => d.count),
                backgroundColor: primaryColor,
                borderColor: primaryColor
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1, precision: 0 }
                }
            }
        }
    });
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sections = [
        {key: 'answerDetailsOpen', id: 'answerDetails'},
        {key: 'myAnswersOpen', id: 'myAnswers'}
    ];
    sections.forEach(({key, id}) => {
        const el = document.getElementById(id);
        if (!el) return;
        const collapse = new bootstrap.Collapse(el, {toggle: false});
        const saved = localStorage.getItem(key);
        if (saved === 'false') {
            collapse.hide();
        } else {
            collapse.show();
        }
        el.addEventListener('shown.bs.collapse', () => localStorage.setItem(key, 'true'));
        el.addEventListener('hidden.bs.collapse', () => localStorage.setItem(key, 'false'));
    });
});
</script>
<script src="{% static 'js/survey_detail_ajax.js' %}"></script>
{% endblock %}
