{% extends 'base.html' %}
{% load i18n static markdown_extras %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
{% if survey.state == 'paused' %}
  <div class="alert alert-info">
    {% blocktrans trimmed with dev_url=dev_url %}
    This survey will be published on 20 August. Welcome back then! However, you can try the development version at <a href="{{ dev_url }}">wikikysely-dev.toolforge.org</a>.
    {% endblocktrans %}
  </div>
{% endif %}
{% if not questions %}
  <p class="alert alert-warning">{% translate 'This survey has no questions yet. Please add questions.' %}</p>
{% endif %}
<p>{{ survey.description|markdownify }}</p>
{% if request.user.is_authenticated %}
  <div class="mb-3">
    {% if survey.state == 'running' %}
      <a href="{% url 'survey:answer_survey' %}" id="answer-survey-btn" class="btn btn-primary  me-2"{% if not unanswered_questions %} style="display:none"{% endif %}>{% translate 'Answer survey' %}</a>
    {% endif %}
    {% if questions %}
      <a href="{% url 'survey:survey_answers' %}" id="answers-btn" class="btn btn-info  me-2"{% if survey.state == 'running' and unanswered_questions %} style="display:none"{% endif %}>{% translate 'View all answers' %}</a>
    {% endif %}
    {% if survey.state == 'running' %}
    <a href="{% url 'survey:question_add' %}" class="btn btn-secondary">{% translate 'Add question' %}</a>
    {% endif %}

  </div>
{% else %}
    {% if questions and  survey.state == 'running' %}
        <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary  me-2">{% translate 'Answer survey' %}</a>
        <a href="{% url 'survey:question_add' %}" class="btn btn-secondary  me-2">{% translate 'Add question' %}</a>
    {% endif %}
{% endif %}
        <h2 id="unanswered-header" class="mt-3"{% if not unanswered_questions %} style="display:none"{% endif %}>{% translate 'Unanswered questions' %}</h2>
      <div class="table-responsive">
      <table id="unanswered-table" class="table mb-3 survey-detail-table card-table"{% if not unanswered_questions %} style="display:none"{% endif %}>
        <thead>
      <tr>
        <th>{% translate 'ID' %}</th>
        <th>{% translate 'Title' %}</th>
        <th>{% translate 'Answers' %}</th>
        <th>{% translate 'Agree' %}</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      {% for q in unanswered_questions %}
        <tr>
        <td class="id-cell d-none d-md-table-cell">{{ q.pk }}</td>
        <td data-label="{% translate 'Title' %}" class="question-cell"><a href="{% url 'survey:answer_question' q.pk %}?next={{ request.get_full_path|urlencode }}">{{ q.text }}</a></td>
        <td data-label="{% translate 'ID' %}" class="id-cell d-md-none">{{ q.pk }}</td>
        <td class="total-answers" data-label="{% translate 'Answers' %}">{{ q.total_answers }}</td>
        <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ q.agree_ratio|floatformat:1 }}%</td>
        <td class="text-end actions" data-label="">
          {% if request.user.is_authenticated and request.user == q.creator and q.total_answers == 0 and survey.state != 'closed' %}
          <a href="{% url 'survey:question_edit' q.pk %}" class="btn btn-sm btn-warning me-2">{% translate 'Edit' %}</a>
          <a href="{% url 'survey:question_delete' q.pk %}" class="btn btn-sm btn-danger ajax-delete-question">{% translate 'Remove question' %}</a>
          {% endif %}
        </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>

{% if user_answers %}
<h2 class="mt-4">{% translate 'My answers' %}</h2>
<div class="table-responsive">
<table class="table mb-3 survey-detail-table card-table">
  <thead>
  <tr>
    <th>{% translate 'ID' %}</th>
    <th>{% translate 'Title' %}</th>
    <th>{% translate 'Answer' %}</th>
    <th>{% translate 'Answers' %}</th>
    <th>{% translate 'Agree' %}</th>
  </tr>
  </thead>
  <tbody>
  {% for a in user_answers %}
    <tr>
      <td class="id-cell d-none d-md-table-cell">{{ a.question.pk }}</td>
      <td data-label="{% translate 'Title' %}" class="question-cell">
        <a href="{% url 'survey:answer_question' a.question.pk %}?next={{ request.get_full_path|urlencode }}">{{ a.question.text }}</a>
      </td>
      <td data-label="{% translate 'Answer' %}" class="answer-cell">
        {% if a.question.survey.state == 'running' %}
        <form method="post" action="{% url 'survey:answer_edit' a.pk %}" class="ajax-answer-form">
          {% csrf_token %}
          <input type="hidden" name="question_id" value="{{ a.question.pk }}">
          <select name="answer" class="form-select form-select-sm answer-select">
            <option value="yes"{% if a.answer == 'yes' %} selected{% endif %}>{% translate 'Yes' %}</option>
            <option value="no"{% if a.answer == 'no' %} selected{% endif %}>{% translate 'No' %}</option>
            <option value="remove">{% translate 'Remove answer' %}</option>
          </select>
          <a href="{% url 'survey:answer_delete' a.pk %}" class="ajax-delete-answer d-none">{% translate 'Remove answer' %}</a>
        </form>
        {% endif %}
      </td>
      <td data-label="{% translate 'ID' %}" class="id-cell d-md-none">{{ a.question.pk }}</td>
      <td class="total-answers" data-label="{% translate 'Answers' %}">{{ a.total_answers }}</td>
      <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ a.agree_ratio|floatformat:1 }}%</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script src="{% static 'js/sort_tables.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    initSortableTables(".survey-detail-table", 1);
});
</script>
<script src="{% static 'js/survey_detail_ajax.js' %}"></script>
{% endblock %}
