{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
{% if survey.state == 'paused' %}
  <div class="alert alert-info">{% translate 'This survey is currently paused.' %}</div>
{% endif %}
{% if not questions %}
  <p class="alert alert-warning">{% translate 'This survey has no questions yet. Please add questions.' %}</p>
{% endif %}
{% if not request.user.is_authenticated and questions %}
  {% if request.GET.login_required %}
    <p class="alert alert-info">
      {% translate 'You must be logged in to answer questions' %}
      <a href="{% url 'login' %}?next={{ request.path }}">{% translate 'Login' %}</a>
    </p>
  {% else %}
    <a href="?login_required=1" class="btn btn-primary">{% translate 'Answer survey' %}</a>
  {% endif %}
{% endif %}
<p>{{ survey.description }}</p>
{% if request.user.is_authenticated %}
  <div class="mb-3">
    {% if unanswered_questions and survey.state == 'running' %}
      <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary">{% translate 'Answer survey' %}</a>
    {% elif questions %}
      <a href="{% url 'survey:survey_results' %}" class="btn btn-info">{% translate 'Results' %}</a>
    {% endif %}
    {% if survey.state == 'running' or can_edit and survey.state != 'closed' %}
      {# Add question button moved to the navbar #}
    {% endif %}
    {% if can_edit %}
    <a href="{% url 'survey:survey_edit' %}" class="btn btn-warning">{% translate 'Edit survey' %}</a>
    {% endif %}
  </div>
{% endif %}
{% if request.user.is_authenticated %}
    {# Edit survey button moved next to the Results button at the bottom #}
    {% if unanswered_questions %}
      <h2 class="mt-3">{% translate 'Unanswered questions' %}</h2>
      <table class="table mb-3">
        <thead>
          <tr>
            <th>{% translate 'Title' %}</th>
            <th>{% translate 'Published' %}</th>
            <th>{% translate 'Answers' %}</th>
            <th>{% translate 'Agree' %}</th>
          </tr>
        </thead>
        <tbody>
        {% for q in unanswered_questions %}
          <tr>
            <td><a href="{% url 'survey:answer_question' q.pk %}">{{ q.text }}</a></td>
            <td>{{ q.created_at }}</td>
            <td>{{ q.total_answers }}</td>
            <td>{% widthratio q.yes_count q.total_answers 100 %}%</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
{% else %}
  <h2 class="mt-3">{% translate 'Questions' %}</h2>
  <ul class="list-group mb-3">
    {% for q in questions %}
    <li class="list-group-item">
      <div><strong>{{ q.text }}</strong></div>
      <small class="text-muted">
        {% translate 'Published' %}: {{ q.created_at }} |
        {% translate 'Answers' %}: {{ q.total_answers }} |
        {% translate 'Agree' %}: {% widthratio q.yes_count q.total_answers 100 %}%
      </small>
    </li>
    {% endfor %}
  </ul>
{% endif %}
{% if user_answers %}
<h2 class="mt-4">{% translate 'My answers' %}</h2>
<table class="table">
  <thead><tr><th>{% translate 'Question' %}</th><th>{% translate 'Answer' %}</th><th></th></tr></thead>
  <tbody>
    {% for a in user_answers %}
    <tr>
      <td><a href="{% url 'survey:answer_question' a.question.pk %}">{{ a.question.text }}</a></td>
      <td>{{ a.get_answer_display }}</td>
      <td>
        {% if survey.state == 'running' %}
        <a href="{% url 'survey:answer_question' a.question.pk %}" class="btn btn-sm btn-warning">{% translate 'Edit' %}</a>
        <a href="{% url 'survey:answer_delete' a.pk %}" class="btn btn-sm btn-danger">{% translate 'Remove answer' %}</a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
{% if questions %}
<a href="{% url 'survey:survey_results' %}" class="btn btn-info mt-3 me-2">{% translate 'Results' %}</a>
{% endif %}
{% endblock %}
