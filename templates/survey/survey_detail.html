{% extends 'base.html' %}
{% load i18n static %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
{% if survey.state == 'paused' %}
  <div class="alert alert-info">{% translate 'This survey is currently paused.' %}</div>
{% endif %}
{% if not questions %}
  <p class="alert alert-warning">{% translate 'This survey has no questions yet. Please add questions.' %}</p>
{% endif %}
{% if not request.user.is_authenticated and questions %}
  {% if request.GET.login_required %}
    <p class="alert alert-info">
      {% translate 'You must be logged in to answer questions' %}.
      <a href="{% url 'login' %}?next={{ request.path }}">{% translate 'Login' %}</a>
    </p>
  {% endif %}
{% endif %}
<p>{{ survey.description }}</p>
{% if request.user.is_authenticated %}
  <div class="mb-3">
    {% if unanswered_questions and survey.state == 'running' %}
      <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary">{% translate 'Answer survey' %}</a>
    {% else %}
      {% if questions %}
        <a href="{% url 'survey:survey_results' %}" class="btn btn-info">{% translate 'Results' %}</a>
      {% endif %}
    {% endif %}
    <a href="{% url 'survey:question_add' %}" class="btn btn-secondary">{% translate 'Add question' %}</a>
  </div>
{% else %}
    {% if questions %}
        <a href="?login_required=1" class="btn btn-primary">{% translate 'Answer survey' %}</a>
    {% endif %}
{% endif %}
<div id="survey-app">
    <div v-if="unanswered.length">
        <h2 class="mt-3">{% translate 'Unanswered questions' %}</h2>
        <table class="table mb-3 survey-detail-table">
            <thead>
            <tr>
                <th>{% translate 'Published' %}</th>
                <th>{% translate 'Title' %}</th>
                <th>{% translate 'Answers' %}</th>
                <th>{% translate 'Agree' %}</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="q in unanswered" :key="q.id">
                <td>{{ q.published }}</td>
                <td>
                    {% if request.user.is_authenticated %}
                    <a :href="'/question/' + q.id + '/'">{{ q.text }}</a>
                    {% else %}
                    {{ q.text }}
                    {% endif %}
                </td>
                <td>{{ q.total_answers }}</td>
                <td>{{ q.agree_ratio }}%</td>
                <td class="text-end">
                    <button v-if="q.can_delete" @click="deleteQuestion(q)" class="btn btn-sm btn-danger">{% translate 'Remove question' %}</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div v-if="answers.length">
        <h2 class="mt-4">{% translate 'My answers' %}</h2>
        <table class="table mb-3 survey-detail-table">
            <thead>
            <tr>
                <th>{% translate 'Published' %}</th>
                <th>{% translate 'Title' %}</th>
                <th>{% translate 'Answers' %}</th>
                <th>{% translate 'Agree' %}</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="a in answers" :key="a.answer_id">
                <td>{{ a.published }}</td>
                <td><a :href="'/question/' + a.question_id + '/'">{{ a.text }}</a></td>
                <td>{{ a.total_answers }}</td>
                <td>{{ a.agree_ratio }}%</td>
                <td class="text-end">
                    <div v-if="a.survey_state === 'running'" class="d-inline">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" :id="'answer-' + a.answer_id + '-yes'" value="yes" :checked="a.answer === 'yes'" @change="saveAnswer(a, 'yes')">
                            <label class="btn btn-sm btn-outline-success" :for="'answer-' + a.answer_id + '-yes'">{{ yesLabel }}</label>
                            <input type="radio" class="btn-check" :id="'answer-' + a.answer_id + '-no'" value="no" :checked="a.answer === 'no'" @change="saveAnswer(a, 'no')">
                            <label class="btn btn-sm btn-outline-danger" :for="'answer-' + a.answer_id + '-no'">{{ noLabel }}</label>
                        </div>
                        <button @click="deleteAnswer(a)" class="btn btn-sm btn-danger ms-2">{% translate 'Remove answer' %}</button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
{% if can_edit %}
   <a href="{% url 'survey:survey_edit' %}" class="btn btn-warning ms-2">{% translate 'Edit survey' %}</a>
{% endif %}

{% endblock %}
{% block scripts %}
<script>
// Enable sorting on survey detail tables
document.addEventListener('DOMContentLoaded', () => {
    const tables = document.querySelectorAll('.survey-detail-table');
    tables.forEach(table => {
        const headers = table.querySelectorAll('th');
        const directions = Array.from(headers, () => null);
        const baseTexts = Array.from(headers, h => h.textContent.trim());

        function clearArrows() {
            headers.forEach((h, i) => {
                h.textContent = baseTexts[i];
            });
        }

        function sortTable(index, direction) {
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const multiplier = direction === 'asc' ? 1 : -1;
            rows.sort((a, b) => {
                const aText = a.children[index].textContent.trim();
                const bText = b.children[index].textContent.trim();
                const aDate = Date.parse(aText);
                const bDate = Date.parse(bText);
                if (!isNaN(aDate) && !isNaN(bDate)) {
                    return (aDate - bDate) * multiplier;
                }
                const aNum = parseFloat(aText);
                const bNum = parseFloat(bText);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return (aNum - bNum) * multiplier;
                }
                return aText.localeCompare(bText, undefined, {numeric: true}) * multiplier;
            });
            rows.forEach(r => tbody.appendChild(r));
        }

        headers.forEach((header, i) => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                const current = directions[i] === 'asc' ? 'desc' : 'asc';
                directions.fill(null);
                directions[i] = current;
                clearArrows();
                header.textContent = baseTexts[i] + (current === 'asc' ? ' \u2191' : ' \u2193');
                sortTable(i, current);
            });
        });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
<script>
window.surveyYesLabel = '{{ yes_label|escapejs }}';
window.surveyNoLabel = '{{ no_label|escapejs }}';
</script>
<script src="{% static 'js/survey_detail.js' %}"></script>
{% endblock %}
