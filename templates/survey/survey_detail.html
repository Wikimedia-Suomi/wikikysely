{% extends 'base.html' %}
{% load i18n static %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
{% if survey.state == 'paused' %}
  <div class="alert alert-info">{% translate 'This survey is currently paused.' %}</div>
{% endif %}
{% if not request.user.is_authenticated and questions %}
  {% if request.GET.login_required %}
    <p class="alert alert-info">
      {% translate 'You must be logged in to answer questions' %}.
      {% if local_login_enabled %}
      <a href="{% url 'login' %}?next={% url 'login_redirect' %}">{% translate 'Login' %}</a>
      {% else %}
      <a href="{% url 'social:begin' 'mediawiki' %}?next={% url 'login_redirect' %}">{% translate 'Login with Wikimedia' %}</a>
      {% endif %}
    </p>
  {% endif %}
{% endif %}
     <p>{{ survey.description }}</p>
<div id="survey-detail-app"
     data-auth="{{ request.user.is_authenticated|yesno:'true,false' }}"
     data-answer-url-template="{% url 'survey:answer_question' 0 %}"
     data-answer-edit-url-template="{% url 'survey:answer_edit' 0 %}"
     data-answer-delete-url-template="{% url 'survey:answer_delete' 0 %}"
     data-question-edit-url-template="{% url 'survey:question_edit' 0 %}"
     data-running="{% if survey.state == 'running' %}true{% else %}false{% endif %}"
     data-answer-survey-url="{% url 'survey:answer_survey' %}">
  <p v-if="loading">{% translate 'Loading...' %}</p>
  <template v-else>
    <div class="mb-3" v-if="isAuthenticated">
      <a v-if="unansweredQuestions.length && isRunning" :href="answerSurveyUrl" class="btn btn-primary">{% translate 'Answer survey' %}</a>
      <a v-else-if="questions.length" href="{% url 'survey:survey_answers' %}" class="btn btn-info">{% translate 'Answers' %}</a>
      <a href="{% url 'survey:question_add' %}" class="btn btn-secondary">{% translate 'Add question' %}</a>
    </div>
    <div class="mb-3" v-else>
      <a v-if="questions.length" href="?login_required=1" class="btn btn-primary">{% translate 'Answer survey' %}</a>
    </div>
    <h2 class="mt-3" v-if="unansweredQuestions.length">{% translate 'Unanswered questions' %}</h2>
    <div class="table-responsive" v-if="unansweredQuestions.length">
      <table class="table mb-3 survey-detail-table stacked-table">
        <thead>
        <tr>
          <th>{% translate 'Published' %}</th>
          <th>{% translate 'Title' %}</th>
          <th>{% translate 'Answers' %}</th>
          <th>{% translate 'Agree' %}</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="q in unansweredQuestions" :key="q.id">
          <td data-label="{% translate 'Published' %}">[[ formatDate(q.created_at) ]]</td>
          <td data-label="{% translate 'Title' %}">
            <a v-if="isAuthenticated" :href="answerUrl(q.id)">[[ q.text ]]</a>
            <span v-else>[[ q.text ]]</span>
          </td>
          <td class="total-answers" data-label="{% translate 'Answers' %}">[[ q.total_answers ]]</td>
          <td class="agree-ratio" data-label="{% translate 'Agree' %}">[[ q.agree_ratio.toFixed(1) ]]%</td>
          <td class="text-end">
            <a v-if="q.total_answers === 0 && q.is_creator" :href="questionEditUrl(q.id)" class="btn btn-sm btn-warning">{% translate 'Edit question' %}</a>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <h2 class="mt-4" v-if="userAnswers.length">{% translate 'My answers' %}</h2>
    <div class="table-responsive" v-if="userAnswers.length">
      <table class="table mb-3 survey-detail-table stacked-table">
        <thead>
        <tr>
          <th>{% translate 'Published' %}</th>
          <th>{% translate 'Title' %}</th>
          <th>{% translate 'Answers' %}</th>
          <th>{% translate 'Agree' %}</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="a in userAnswers" :key="a.id">
          <td data-label="{% translate 'Published' %}">[[ formatDate(a.created_at) ]]</td>
          <td data-label="{% translate 'Title' %}"><a :href="answerUrl(a.id)">[[ a.text ]]</a></td>
          <td class="total-answers" data-label="{% translate 'Answers' %}">[[ a.total_answers ]]</td>
          <td class="agree-ratio" data-label="{% translate 'Agree' %}">[[ a.agree_ratio.toFixed(1) ]]%</td>
          <td class="text-end">
            <template v-if="isRunning">
              <form class="d-inline" @change="updateAnswer(a)">
                <input type="hidden" name="question_id" :value="a.id">
                <div class="btn-group yes-no-group" role="group">
                  <input type="radio" class="btn-check" :name="'answer-' + a.id" :id="'answer-' + a.id + '-yes'" value="yes" v-model="a.my_answer">
                  <label class="btn btn-sm btn-outline-success" :for="'answer-' + a.id + '-yes'">{% translate 'Yes' %}</label>
                  <input type="radio" class="btn-check" :name="'answer-' + a.id" :id="'answer-' + a.id + '-no'" value="no" v-model="a.my_answer">
                  <label class="btn btn-sm btn-outline-danger" :for="'answer-' + a.id + '-no'">{% translate 'No' %}</label>
                </div>
              </form>
              <a :href="deleteUrl(a.my_answer_id)" class="btn btn-sm btn-danger ms-2" @click.prevent="deleteAnswer(a)">{% translate 'Remove answer' %}</a>
            </template>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <p class="alert alert-warning" v-if="!unansweredQuestions.length && !userAnswers.length">
      {% translate 'This survey has no questions yet. Please add questions.' %}
    </p>
  </template>
</div>
{% if can_edit %}
   <a href="{% url 'survey:survey_edit' %}" class="btn btn-warning ms-2">{% translate 'Edit survey' %}</a>
{% endif %}

{% endblock %}
{% block scripts %}
<script src="{% static 'js/sort_tables.js' %}"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
  window.questionsJsonUrl = "{% url 'survey:questions_json' %}";
</script>
<script src="{% static 'js/survey_detail_vue.js' %}"></script>
{% endblock %}
