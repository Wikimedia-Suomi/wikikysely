{% extends 'base.html' %}
{% load i18n static markdown_extras %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
{% if survey.state == 'paused' %}
  <div class="alert alert-info">
    {% blocktrans trimmed with dev_url=dev_url %}
    This survey will be published on 20 August. Welcome back then! However, you can try the development version at <a href="{{ dev_url }}">wikikysely-dev.toolforge.org</a>.
    {% endblocktrans %}
  </div>
{% endif %}
{% if not questions %}
  <p class="alert alert-warning">{% translate 'This survey has no questions yet. Please add questions.' %}</p>
{% endif %}
<p>{{ survey.description|markdownify }}</p>
{% if request.user.is_authenticated %}
  <div class="mb-3">
    {% if survey.state == 'running' %}
      <a href="{% url 'survey:answer_survey' %}" id="answer-survey-btn" class="btn btn-primary"{% if not unanswered_questions %} style="display:none"{% endif %}>{% translate 'Answer survey' %}</a>
    {% endif %}
    {% if questions %}
      <a href="{% url 'survey:survey_answers' %}" id="answers-btn" class="btn btn-info"{% if survey.state == 'running' and unanswered_questions %} style="display:none"{% endif %}>{% translate 'Answers' %}</a>
    {% endif %}
    <a href="{% url 'survey:question_add' %}" class="btn btn-secondary">{% translate 'Add question' %}</a>
  </div>
{% else %}
    {% if questions %}
        <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary">{% translate 'Answer survey' %}</a>
    {% endif %}
{% endif %}
        <h2 id="unanswered-header" class="mt-3"{% if not unanswered_questions %} style="display:none"{% endif %}>{% translate 'Unanswered questions' %}</h2>
      <div class="table-responsive d-none d-md-block">
      <table id="unanswered-table" class="table mb-3 survey-detail-table"{% if not unanswered_questions %} style="display:none"{% endif %}>
        <thead>
      <tr>
        <th>{% translate 'ID' %}</th>
        <th>{% translate 'Title' %}</th>
        <th>{% translate 'Answers' %}</th>
        <th>{% translate 'Agree' %}</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      {% for q in unanswered_questions %}
        <tr>
        <td data-label="{% translate 'ID' %}">{{ q.pk }}</td>
        <td data-label="{% translate 'Title' %}"><a href="{% url 'survey:answer_question' q.pk %}?next={{ request.get_full_path|urlencode }}">{{ q.text }}</a></td>
        <td class="total-answers" data-label="{% translate 'Answers' %}">{{ q.total_answers }}</td>
        <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ q.agree_ratio|floatformat:1 }}%</td>
        <td class="text-end" data-label="">
          {% if request.user.is_authenticated and request.user == q.creator and q.total_answers == 0 and survey.state != 'closed' %}
          <a href="{% url 'survey:question_edit' q.pk %}" class="btn btn-sm btn-warning me-2">{% translate 'Edit' %}</a>
          <a href="{% url 'survey:question_delete' q.pk %}" class="btn btn-sm btn-danger ajax-delete-question">{% translate 'Remove question' %}</a>
          {% endif %}
        </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
      <div class="d-md-none"{% if not unanswered_questions %} style="display:none"{% endif %}>
      {% for q in unanswered_questions %}
        <div class="card mb-3">
          <div class="card-header">
            {{ q.pk }}. <a href="{% url 'survey:answer_question' q.pk %}?next={{ request.get_full_path|urlencode }}">{{ q.text }}</a>
          </div>
          <div class="card-body">
            <div class="progress" style="height: 1.25rem;">
              <div class="progress-bar bg-success text-black" role="progressbar" style="width: {% widthratio q.yes_count q.total_answers 100 %}%">{{ q.yes_count }}</div>
              <div class="progress-bar bg-danger text-light" role="progressbar" style="width: {% widthratio q.no_count q.total_answers 100 %}%">{{ q.no_count }}</div>
            </div>
          </div>
        </div>
      {% endfor %}
      </div>

{% if user_answers %}
<h2 class="mt-4">{% translate 'My answers' %}</h2>
<div class="table-responsive d-none d-md-block">
<table class="table mb-3 survey-detail-table">
  <thead>
  <tr>
    <th>{% translate 'ID' %}</th>
    <th>{% translate 'Title' %}</th>
    <th>{% translate 'Answers' %}</th>
    <th>{% translate 'Agree' %}</th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  {% for a in user_answers %}
    <tr>
      <td data-label="{% translate 'ID' %}">{{ a.question.pk }}</td>
      <td data-label="{% translate 'Title' %}">
        <a href="{% url 'survey:answer_question' a.question.pk %}?next={{ request.get_full_path|urlencode }}">{{ a.question.text }}</a>
      </td>
      <td class="total-answers" data-label="{% translate 'Answers' %}">{{ a.total_answers }}</td>
      <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ a.agree_ratio|floatformat:1 }}%</td>
      <td class="text-end" data-label="">
        {% if a.question.survey.state == 'running' %}
        <form method="post" action="{% url 'survey:answer_edit' a.pk %}" class="d-inline ajax-answer-form">
          {% csrf_token %}
          <input type="hidden" name="question_id" value="{{ a.question.pk }}">
          <div class="btn-group yes-no-group" role="group" aria-label="{% translate 'Answer' %}">
            <input type="radio" class="btn-check" name="answer" id="answer-{{ a.pk }}-yes" value="yes"{% if a.answer == 'yes' %} checked{% endif %}>
            <label class="btn btn-sm btn-outline-success" for="answer-{{ a.pk }}-yes">{% translate 'Yes' %}</label>
            <input type="radio" class="btn-check" name="answer" id="answer-{{ a.pk }}-no" value="no"{% if a.answer == 'no' %} checked{% endif %}>
            <label class="btn btn-sm btn-outline-danger" for="answer-{{ a.pk }}-no">{% translate 'No' %}</label>
          </div>
        </form>
        <a href="{% url 'survey:answer_delete' a.pk %}" class="btn btn-sm btn-danger ms-2 ajax-delete-answer">{% translate 'Remove answer' %}</a>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>
<div class="d-md-none">
  {% for a in user_answers %}
  <div class="card mb-3">
    <div class="card-header">
      {{ a.question.pk }}. <a href="{% url 'survey:answer_question' a.question.pk %}?next={{ request.get_full_path|urlencode }}">{{ a.question.text }}</a>
    </div>
    <div class="card-body">
      <div class="progress mb-3" style="height: 1.25rem;">
        <div class="progress-bar bg-success text-black" role="progressbar" style="width: {% widthratio a.yes_count a.total_answers 100 %}%">{{ a.yes_count }}</div>
        <div class="progress-bar bg-danger text-light" role="progressbar" style="width: {% widthratio a.no_count a.total_answers 100 %}%">{{ a.no_count }}</div>
      </div>
      {% if a.question.survey.state == 'running' %}
      <form method="post" action="{% url 'survey:answer_edit' a.pk %}" class="d-inline ajax-answer-form">
        {% csrf_token %}
        <input type="hidden" name="question_id" value="{{ a.question.pk }}">
        <div class="btn-group yes-no-group" role="group" aria-label="{% translate 'Answer' %}">
          <input type="radio" class="btn-check" name="answer" id="mobile-answer-{{ a.pk }}-yes" value="yes"{% if a.answer == 'yes' %} checked{% endif %}>
          <label class="btn btn-sm btn-outline-success" for="mobile-answer-{{ a.pk }}-yes">{% translate 'Yes' %}</label>
          <input type="radio" class="btn-check" name="answer" id="mobile-answer-{{ a.pk }}-no" value="no"{% if a.answer == 'no' %} checked{% endif %}>
          <label class="btn btn-sm btn-outline-danger" for="mobile-answer-{{ a.pk }}-no">{% translate 'No' %}</label>
        </div>
      </form>
      <a href="{% url 'survey:answer_delete' a.pk %}" class="btn btn-sm btn-danger ms-2 ajax-delete-answer">{% translate 'Remove answer' %}</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script src="{% static 'js/sort_tables.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    initSortableTables(".survey-detail-table", 0);
});
</script>
<script src="{% static 'js/survey_detail_ajax.js' %}"></script>
{% endblock %}
