{% extends 'base.html' %}
{% load i18n static %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
{% if survey.state == 'paused' %}
  <div class="alert alert-info">{% translate 'This survey is currently paused.' %}</div>
{% endif %}
{% if not request.user.is_authenticated and request.GET.login_required %}
  <p class="alert alert-info">
    {% translate 'You must be logged in to answer questions' %}.
    {% if local_login_enabled %}
    <a href="{% url 'login' %}?next={% url 'login_redirect' %}">{% translate 'Login' %}</a>
    {% else %}
    <a href="{% url 'social:begin' 'mediawiki' %}?next={% url 'login_redirect' %}">{% translate 'Login with Wikimedia' %}</a>
    {% endif %}
  </p>
{% endif %}
<p>{{ survey.description }}</p>
{% if request.user.is_authenticated %}
  <div class="mb-3">
    {% if unanswered_count and survey.state == 'running' %}
      <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary">{% translate 'Answer survey' %}</a>
    {% else %}
      <a href="{% url 'survey:survey_answers' %}" class="btn btn-info">{% translate 'Answers' %}</a>
    {% endif %}
    <a href="{% url 'survey:question_add' %}" class="btn btn-secondary">{% translate 'Add question' %}</a>
  </div>
{% else %}
  {% if unanswered_count %}
    <a href="?login_required=1" class="btn btn-primary">{% translate 'Answer survey' %}</a>
  {% endif %}
{% endif %}

<div id="survey-app" data-api-url="{% url 'survey:questions_api' %}">
  <h2 v-if="unanswered.length" class="mt-3">{% translate 'Unanswered questions' %}</h2>
  <div v-if="unanswered.length" class="table-responsive">
    <table class="table mb-3 survey-detail-table stacked-table">
      <thead>
        <tr>
          <th>{% translate 'Published' %}</th>
          <th>{% translate 'Title' %}</th>
          <th>{% translate 'Answers' %}</th>
          <th>{% translate 'Agree' %}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="q in unanswered" :key="q.id">
          <td data-label="{% translate 'Published' %}">{{ q.published }}</td>
          <td data-label="{% translate 'Title' %}"><a :href="q.url">{{ q.text }}</a></td>
          <td class="total-answers" data-label="{% translate 'Answers' %}">{{ q.total }}</td>
          <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ q.agree_ratio }}%</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 v-if="answers.length" class="mt-4">{% translate 'My answers' %}</h2>
  <div v-if="answers.length" class="table-responsive">
    <table class="table mb-3 survey-detail-table stacked-table">
      <thead>
        <tr>
          <th>{% translate 'Published' %}</th>
          <th>{% translate 'Title' %}</th>
          <th>{% translate 'Answers' %}</th>
          <th>{% translate 'Agree' %}</th>
          <th>{% translate 'My answer' %}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="a in answers" :key="a.id">
          <td data-label="{% translate 'Published' %}">{{ a.question_published }}</td>
          <td data-label="{% translate 'Title' %}"><a :href="a.question_url">{{ a.question_text }}</a></td>
          <td class="total-answers" data-label="{% translate 'Answers' %}">{{ a.total }}</td>
          <td class="agree-ratio" data-label="{% translate 'Agree' %}">{{ a.agree_ratio }}%</td>
          <td data-label="{% translate 'My answer' %}">{{ a.answer_display }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

{% if can_edit %}
   <a href="{% url 'survey:survey_edit' %}" class="btn btn-warning ms-2">{% translate 'Edit survey' %}</a>
{% endif %}
{% endblock %}
{% block scripts %}
<script src="{% static 'js/sort_tables.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="{% static 'js/survey_questions.js' %}"></script>
{% endblock %}

