{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
<h1>{{ survey.title }}</h1>
<p>{{ survey.description }}</p>
<p>{% translate 'State' %}: {{ survey.get_state_display }}</p>
<p>{% translate 'Start date' %}: {{ survey.start_date }} | {% translate 'End date' %}: {{ survey.end_date }}</p>
{% if survey.state == 'paused' %}
  <div class="alert alert-info">{% translate 'This survey is currently paused.' %}</div>
{% endif %}
{% if not questions %}
  <p class="alert alert-warning">{% translate 'This survey has no questions yet. Please add questions.' %}</p>
{% endif %}
{% if request.user.is_authenticated %}
    {# Edit survey button moved next to the Results button at the bottom #}
    {% if unanswered_questions %}
      <h2 class="mt-3">{% translate 'Unanswered questions' %}</h2>
      <ul class="list-group mb-3">
        {% for q in unanswered_questions %}
        <li class="list-group-item">
          <div><strong>{{ q.text }}</strong></div>
          <small class="text-muted">
            {% translate 'Published' %}: {{ q.created_at }} |
            {% translate 'Answers' %}: {{ q.total_answers }} |
            {% translate 'Agree' %}: {% widthratio q.yes_count q.total_answers 100 %}%
          </small>
        </li>
        {% endfor %}
      </ul>
    {% endif %}
  <div class="mb-3">
      {% if unanswered_questions and survey.state == 'running' %}
        <a href="{% url 'survey:answer_survey' survey.pk %}" class="btn btn-primary me-2">{% translate 'Answer survey' %}</a>
      {% elif questions %}
        <a href="{% url 'survey:survey_results' survey.pk %}" class="btn btn-info me-2">{% translate 'Results' %}</a>
      {% endif %}
      {% if survey.state == 'running' or can_edit and survey.state != 'closed' %}
        <a href="{% url 'survey:question_add' survey_pk=survey.pk %}" class="btn btn-secondary">{% translate 'Add question' %}</a>
      {% endif %}
      </div>
{% elif can_edit %}
    <div class="mb-2">
      {% if survey.state != 'closed' %}
      <a href="{% url 'survey:question_add' survey_pk=survey.pk %}" class="btn btn-secondary me-2">{% translate 'Add question' %}</a>
      {% endif %}
    </div>
{% else %}
  {% if questions %}
  <p class="alert alert-info">{% translate 'You must be logged in to answer questions' %}</p>
  {% endif %}
  <h2 class="mt-3">{% translate 'Questions' %}</h2>
  <ul class="list-group mb-3">
    {% for q in questions %}
    <li class="list-group-item">
      <div><strong>{{ q.text }}</strong></div>
      <small class="text-muted">
        {% translate 'Published' %}: {{ q.created_at }} |
        {% translate 'Answers' %}: {{ q.total_answers }} |
        {% translate 'Agree' %}: {% widthratio q.yes_count q.total_answers 100 %}%
      </small>
    </li>
    {% endfor %}
  </ul>
{% endif %}
{% if user_answers %}
<h2 class="mt-4">{% translate 'My answers' %}</h2>
<table class="table">
  <thead><tr><th>{% translate 'Question' %}</th><th>{% translate 'Answer' %}</th><th></th></tr></thead>
  <tbody>
    {% for a in user_answers %}
    <tr>
      <td>{{ a.question.text }}</td>
      <td>{{ a.get_answer_display }}</td>
      <td>
        {% if survey.state == 'running' %}
        <a href="{% url 'survey:answer_edit' a.pk %}" class="btn btn-sm btn-warning">{% translate 'Edit' %}</a>
        <a href="{% url 'survey:answer_delete' a.pk %}" class="btn btn-sm btn-danger">{% translate 'Remove' %}</a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
{% if questions %}
<a href="{% url 'survey:survey_results' survey.pk %}" class="btn btn-info mt-3 me-2">{% translate 'Results' %}</a>
{% endif %}
{% if can_edit %}
<a href="{% url 'survey:survey_edit' survey.pk %}" class="btn btn-warning mt-3">{% translate 'Edit survey' %}</a>
{% endif %}
{% endblock %}
