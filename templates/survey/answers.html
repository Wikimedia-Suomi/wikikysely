{% extends 'base.html' %}
{% load i18n static markdown_extras %}
{% block title %}{% translate 'Answers' %}{% endblock %}
{% block content %}
<p>{{ survey.description|markdownify }}</p>
{% if request.user.is_authenticated %}
    {% if data and survey.state == 'running' %}
      {% if unanswered_count %}
      <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary mb-3 me-2">{% translate 'Answer survey' %}</a>
      {% endif %}
      <a href="{% url 'survey:survey_answers_wikitext' %}" class="btn btn-secondary mb-3">{% translate 'Print wikitext' %}</a>
    {% endif %}
{% else %}
    {% if data %}
      <a href="{% url 'survey:answer_survey' %}" class="btn btn-primary mb-3 me-2">{% translate 'Answer survey' %}</a>
      <a href="{% url 'survey:survey_answers_wikitext' %}" class="btn btn-secondary mb-3">{% translate 'Print wikitext' %}</a>
  {% endif %}
  {% endif %}
<h1>{% translate 'Answers' %}</h1>
{% translate 'Red' as red_label %}
{% translate 'Green' as green_label %}
{% translate 'Grey' as grey_label %}
<p id="chartInfo">
  {% blocktrans trimmed with red=red_label green=green_label grey=grey_label yes=yes_label no=no_label %}
  <span class="bg-danger text-light px-1">{{ red }}</span> means {{ no }} answers and <span class="bg-success text-black px-1">{{ green }}</span> means {{ yes }} answers. <span id="unansweredInfo" style="display:none"><span class="bg-secondary px-1">{{ grey }}</span> shows the share of all respondents who have not yet answered the question.</span> <span id="pieSizeInfo" style="display:none">The size of the circle is proportional to the number of respondents.</span>
  {% endblocktrans %}
</p>
<div class="mb-3">
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="pieChartRadio" value="pie" checked>
    <label class="form-check-label" for="pieChartRadio">{% translate 'Pie chart' %}</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="barChartRadio" value="bar">
    <label class="form-check-label" for="barChartRadio">{% translate 'Bar chart' %}</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="tableChartRadio" value="table">
    <label class="form-check-label" for="tableChartRadio">{% translate 'Answer table' %}</label>
  </div>
</div>
<div class="table-responsive">
<table id="barChartTable" class="table" style="display:none">
  <tbody>
  {% for row in data %}
  <tr>
    <td>{{ row.question.pk }}</td>
    <td class="bar-chart-question">
       <a href="{% url 'survey:answer_question' row.question.pk %}?next={{ request.get_full_path|urlencode }}">{{ row.question.text }}</a>
    </td>
    <td class="w-100">
      <div class="progress" style="height: 1.25rem;">
        <div class="progress-bar bg-success text-black" role="progressbar" style="width: {% widthratio row.yes total_users 100 %}%" aria-valuenow="{{ row.yes }}" aria-valuemin="0" aria-valuemax="{{ total_users }}">{{ row.yes }}</div>
        <div class="progress-bar bg-danger text-light" role="progressbar" style="width: {% widthratio row.no total_users 100 %}%" aria-valuenow="{{ row.no }}" aria-valuemin="0" aria-valuemax="{{ total_users }}">{{ row.no }}</div>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>
<div id="pieChartsContainer" style="display:none">
  <div id="pieCharts" class="d-flex flex-wrap gap-4 mt-4 justify-content-center">
{% for row in data %}
  <div class="pie-chart text-center" data-yes="{{ row.yes }}" data-no="{{ row.no }}" data-total="{{ row.total }}">
    <canvas></canvas>
    <p class="mt-2">
      {{ row.question.pk }}. <a href="{% url 'survey:answer_question' row.question.pk %}?next={{ request.get_full_path|urlencode }}">{{ row.question.text }}</a>
    </p>
  </div>
{% endfor %}
</div>
</div>
<p class="mt-3">{% translate 'Total respondents' %}: {{ total_users }}</p>
<div id="answerTableContainer" style="display:none">
  <h2>{% translate 'Answer table' %}</h2>
  <div class="table-responsive">
  <table id="answerTable" class="table stacked-table">
  <thead>
  <tr>
    <th>{% translate 'ID' %}</th>
    <th>{% translate 'Published' %}</th>
    <th>{% translate 'Question' %}</th>
    {% if request.user.is_authenticated %}
    <th>{% translate 'My answer' %}</th>
    {% endif %}
    <th>{% translate 'Yes' %}</th>
    <th>{% translate 'No' %}</th>
    <th>{% translate 'Total' %}</th>
    <th>{% translate 'Agree' %}</th>
  </tr>
  </thead>
  <tbody>
  {% for row in data %}
  <tr>
    <td data-label="{% translate 'ID' %}">{{ row.question.pk }}</td>
    <td data-label="{% translate 'Published' %}">{{ row.published|date:"Y-m-d" }}</td>
    <td data-label="{% translate 'Question' %}">
        <a href="{% url 'survey:answer_question' row.question.pk %}?next={{ request.get_full_path|urlencode }}">{{ row.question.text }}</a>
    </td>
    {% if request.user.is_authenticated %}
    <td data-label="{% translate 'My answer' %}">{{ row.my_answer | default:""}}</td>
    {% endif %}
    <td data-label="{% translate 'Yes' %}">{{ row.yes }}</td>
    <td data-label="{% translate 'No' %}">{{ row.no }}</td>
    <td data-label="{% translate 'Total' %}">{{ row.total }}</td>
    <td data-label="{% translate 'Agree' %}">{{ row.agree_ratio|floatformat:1 }}%</td>
  </tr>
  {% endfor %}
  </tbody>
  </table>
  </div>
</div>
<!--h2>{% translate 'Survey information' %}</h2>
<dl class='survey-data'>
  <div>
     <dt>{% translate 'Number of questions' %}</dt>
     <dd>{{ question_count }}</dd>
  </div>
  <div>
     <dt>{% translate 'Number of respondents' %}</dt>
     <dd>{{ total_users }}</dd>
  </div>
  <div>
     <dt>{% translate 'Number of question authors' %}</dt>
     <dd>{{ question_author_count }}</dd>
  </div>
</dl-->
{% endblock %}
{% block scripts %}
<script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
<script>
Chart.register(ChartDataLabels);
const yesLabel = '{{ yes_label|escapejs }}';
const noLabel = '{{ no_label|escapejs }}';
const noAnswersLabel = '{{ no_answers_label|escapejs }}';
const successColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-success').trim() || 'green';
const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-danger').trim() || 'red';
const placeholderColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-secondary-bg').trim() ||
    getComputedStyle(document.documentElement).getPropertyValue('--bs-secondary').trim() || 'gray';

// Pie charts
const pieContainers = document.querySelectorAll('#pieCharts .pie-chart');
const totals = Array.from(pieContainers, el => parseInt(el.dataset.total));
const maxTotal = Math.max(...totals, 1);
const maxSize = 200;
pieContainers.forEach(el => {
    const yes = parseInt(el.dataset.yes);
    const no = parseInt(el.dataset.no);
    const total = parseInt(el.dataset.total);
    const placeholderSize = 100;
    const size = total === 0 ? placeholderSize : maxSize * Math.sqrt(total / maxTotal);
    const canvas = el.querySelector('canvas');
    canvas.width = size;
    canvas.height = size;
    const data = total === 0 ? [1] : [yes, no];
    const colors = total === 0 ? [placeholderColor] : [successColor, dangerColor];
    new Chart(canvas, {
        type: 'pie',
        data: {
            labels: total === 0 ? [noAnswersLabel] : [yesLabel, noLabel],
            datasets: [{
                data: data,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            events: [],
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    return value !== 0 && total !== 0;
		    },
                    formatter: value => value,
                    font: { weight: 'bold', size: 20  },
 		    color: '#000',
		    borderWidth: 2,
		    borderRadius: 4,
		    padding: 4

                }
            }
        }
    });
});

function updateChartVisibility(type) {
    const barEl = document.getElementById('barChartTable');
    const pieEl = document.getElementById('pieChartsContainer');
    const tableEl = document.getElementById('answerTableContainer');
    const infoTextEl = document.getElementById('chartInfo');
    const greyInfoEl = document.getElementById('unansweredInfo');
    const pieSizeInfoEl = document.getElementById('pieSizeInfo');
    if (type === 'bar') {
        barEl.style.display = '';
        pieEl.style.display = 'none';
        tableEl.style.display = 'none';
        infoTextEl.style.display = '';
        greyInfoEl.style.display = '';
        pieSizeInfoEl.style.display = 'none';
    } else if (type === 'pie') {
        barEl.style.display = 'none';
        pieEl.style.display = '';
        tableEl.style.display = 'none';
        infoTextEl.style.display = '';
        greyInfoEl.style.display = 'none';
        pieSizeInfoEl.style.display = '';
    } else {
        barEl.style.display = 'none';
        pieEl.style.display = 'none';
        tableEl.style.display = '';
        infoTextEl.style.display = 'none';
        greyInfoEl.style.display = 'none';
        pieSizeInfoEl.style.display = 'none';
    }
 }

const chartTypeKey = 'resultsChartType';
let savedType = localStorage.getItem(chartTypeKey) || 'pie';
document.getElementById(savedType + 'ChartRadio').checked = true;
updateChartVisibility(savedType);

document.querySelectorAll('input[name="chartType"]').forEach(radio => {
    radio.addEventListener('change', e => {
        const type = e.target.value;
        localStorage.setItem(chartTypeKey, type);
        updateChartVisibility(type);
    });
});
</script>
<script src="{% static 'js/sort_tables.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    initSortableTables("#answerTable", 1);
});
</script>
{% endblock %}
