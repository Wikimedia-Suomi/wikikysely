{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
<h1>{{ survey.title }} - {% translate 'Results' %}</h1>
<div class="mb-3">
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="barChartRadio" value="bar" checked>
    <label class="form-check-label" for="barChartRadio">{% translate 'Bar chart' %}</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="pieChartRadio" value="pie">
    <label class="form-check-label" for="pieChartRadio">{% translate 'Pie chart' %}</label>
  </div>
</div>
<table id="barChartTable" class="table" style="display:none">
  <tbody>
  {% for row in data %}
  <tr>
    <td class="bar-chart-question">{{ row.question.text }}</td>
    <td class="w-100">
      <div class="progress" style="height: 1rem;">
        <div class="progress-bar bg-success" role="progressbar" style="width: {% widthratio row.yes total_users 100 %}%"></div>
        <div class="progress-bar bg-danger" role="progressbar" style="width: {% widthratio row.no total_users 100 %}%"></div>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
<div id="pieChartsContainer" style="display:none">
  <div id="pieCharts" class="d-flex flex-wrap gap-4 mt-4">
{% for row in data %}
  <div class="pie-chart text-center" data-yes="{{ row.yes }}" data-no="{{ row.no }}" data-total="{{ row.total }}">
    <canvas></canvas>
    <p class="mt-2">{{ row.question.text }}</p>
  </div>
{% endfor %}
</div>
</div>
<p class="mt-3">{% translate 'Total respondents' %}: {{ total_users }}</p>
<h2>{% translate 'Answer table' %}</h2>
<table class="table">
<thead><tr><th>{% translate 'Question' %}</th><th>{% translate 'Yes' %}</th><th>{% translate 'No' %}</th><th>{% translate 'Total' %}</th></tr></thead>
<tbody>
{% for row in data %}
<tr>
  <td>
    {% if request.user.is_authenticated %}
      <a href="{% url 'survey:answer_question' row.question.pk %}">{{ row.question.text }}</a>
    {% else %}
      {{ row.question.text }}
    {% endif %}
  </td>
  <td>{{ row.yes }}</td>
  <td>{{ row.no }}</td>
  <td>{{ row.total }}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endblock %}
{% block scripts %}
<script>
const yesLabel = '{{ yes_label|escapejs }}';
const noLabel = '{{ no_label|escapejs }}';
const successColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-success').trim() || 'green';
const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-danger').trim() || 'red';

// Pie charts
const pieContainers = document.querySelectorAll('#pieCharts .pie-chart');
const totals = Array.from(pieContainers, el => parseInt(el.dataset.total));
const maxTotal = Math.max(...totals, 1);
const maxSize = 200;
pieContainers.forEach(el => {
    const yes = parseInt(el.dataset.yes);
    const no = parseInt(el.dataset.no);
    const total = parseInt(el.dataset.total);
    const size = maxSize * Math.sqrt(total / maxTotal);
    const canvas = el.querySelector('canvas');
    canvas.width = size;
    canvas.height = size;
    new Chart(canvas, {
        type: 'pie',
        data: {
            labels: [yesLabel, noLabel],
            datasets: [{
                data: [yes, no],
                backgroundColor: [successColor, dangerColor]
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
});

function updateChartVisibility(type) {
    const barEl = document.getElementById('barChartTable');
    const pieEl = document.getElementById('pieChartsContainer');
    if (type === 'bar') {
        barEl.style.display = '';
        pieEl.style.display = 'none';
    } else {
        barEl.style.display = 'none';
        pieEl.style.display = '';
    }
}

const chartTypeKey = 'resultsChartType';
let savedType = localStorage.getItem(chartTypeKey) || 'bar';
document.getElementById(savedType + 'ChartRadio').checked = true;
updateChartVisibility(savedType);

document.querySelectorAll('input[name="chartType"]').forEach(radio => {
    radio.addEventListener('change', e => {
        const type = e.target.value;
        localStorage.setItem(chartTypeKey, type);
        updateChartVisibility(type);
    });
});
</script>
{% endblock %}
