{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
<h1>{{ survey.title }} - {% translate 'Results' %}</h1>
<div class="mb-3">
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="barChartRadio" value="bar" checked>
    <label class="form-check-label" for="barChartRadio">{% translate 'Bar chart' %}</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="chartType" id="pieChartRadio" value="pie">
    <label class="form-check-label" for="pieChartRadio">{% translate 'Pie chart' %}</label>
  </div>
</div>
<div id="resultsChartContainer" style="display:none" class="position-relative">
  <div id="barChartLabels"></div>
  <canvas id="resultsChart"></canvas>
</div>
<div id="pieChartsContainer" style="display:none">
  <div id="pieCharts" class="d-flex flex-wrap gap-4 mt-4">
{% for row in data %}
  <div class="pie-chart text-center" data-yes="{{ row.yes }}" data-no="{{ row.no }}" data-total="{{ row.total }}">
    <canvas></canvas>
    <p class="mt-2">{{ row.question.text }}</p>
  </div>
{% endfor %}
</div>
</div>
<p class="mt-3">{% translate 'Total respondents' %}: {{ total_users }}</p>
<table class="table">
<thead><tr><th>{% translate 'Question' %}</th><th>{% translate 'Yes' %}</th><th>{% translate 'No' %}</th><th>{% translate 'Total' %}</th></tr></thead>
<tbody>
{% for row in data %}
<tr><td>{{ row.question.text }}</td><td>{{ row.yes }}</td><td>{{ row.no }}</td><td>{{ row.total }}</td></tr>
{% endfor %}
</tbody>
</table>
{% endblock %}
{% block scripts %}
<script>
const data = {
    labels: [{% for row in data %}'{{ row.question.text|escapejs }}',{% endfor %}],
    datasets: [
        {label: '{{ yes_label|escapejs }}', data: [{% for row in data %}{{ row.yes }},{% endfor %}], backgroundColor: 'green'},
        {label: '{{ no_label|escapejs }}', data: [{% for row in data %}{{ row.no }},{% endfor %}], backgroundColor: 'red'}
    ]
};

const pieData = [
    {% for row in data %}{ yes: {{ row.yes }}, no: {{ row.no }}, total: {{ row.total }} },{% endfor %}
];
const yesLabel = '{{ yes_label|escapejs }}';
const noLabel = '{{ no_label|escapejs }}';

// Calculate appropriate height based on number of questions
const chartEl = document.getElementById('resultsChart');
const labelsEl = document.getElementById('barChartLabels');
const lineHeight = parseFloat(getComputedStyle(document.body).lineHeight);
const barHeight = Math.ceil(lineHeight * 1.2);
const chartHeight = barHeight * data.labels.length + 100; // +100 for padding, legend, etc.

// Set container height and disable responsive behavior
chartEl.style.height = `${chartHeight}px`;
chartEl.style.width = '100%';
data.labels.forEach(text => {
    const div = document.createElement('div');
    div.className = 'chart-label';
    div.textContent = text;
    div.style.height = `${barHeight}px`;
    labelsEl.appendChild(div);
});

new Chart(chartEl, {
    type: 'bar',
    data: data,
    options: {
        responsive: false, // Disable responsive behavior
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: { 
                stacked: true, 
                max: {{ total_users }},
                grid: {
                    display: true
                },
                ticks: {
                    stepSize: 1,
                    precision: 0
                }
            },
            y: {
                stacked: true,
                grid: {
                    display: false
                },
                ticks: {
                    display: false
                }
            }
        },
        plugins: {
            legend: { 
                display: true,
                position: 'top'
            }
        },
        // Control bar thickness more precisely
        elements: {
            bar: {
                borderWidth: 0
            }
        },
        layout: {
            padding: {
                top: 20,
                bottom: 20,
                left: 10,
                right: 10
            }
        }
    }
});

const chart = Chart.getChart(chartEl);
const chartTop = chart.chartArea.top;
labelsEl.style.top = chartTop + 'px';
const labelWidth = labelsEl.offsetWidth + 10;
chartEl.style.marginLeft = labelWidth + 'px';
chartEl.style.width = `calc(100% - ${labelWidth}px)`;

// Pie charts
const pieContainers = document.querySelectorAll('#pieCharts .pie-chart');
const totals = Array.from(pieContainers, el => parseInt(el.dataset.total));
const maxTotal = Math.max(...totals, 1);
const maxSize = 200;
pieContainers.forEach((el, idx) => {
    const yes = parseInt(el.dataset.yes);
    const no = parseInt(el.dataset.no);
    const total = parseInt(el.dataset.total);
    const size = maxSize * Math.sqrt(total / maxTotal);
    const canvas = el.querySelector('canvas');
    canvas.width = size;
    canvas.height = size;
    new Chart(canvas, {
        type: 'pie',
        data: {
            labels: [yesLabel, noLabel],
            datasets: [{
                data: [yes, no],
                backgroundColor: ['green', 'red']
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
});

function updateChartVisibility(type) {
    const barEl = document.getElementById('resultsChartContainer');
    const pieEl = document.getElementById('pieChartsContainer');
    if (type === 'bar') {
        barEl.style.display = '';
        pieEl.style.display = 'none';
    } else {
        barEl.style.display = 'none';
        pieEl.style.display = '';
    }
}

const chartTypeKey = 'resultsChartType';
let savedType = localStorage.getItem(chartTypeKey) || 'bar';
document.getElementById(savedType + 'ChartRadio').checked = true;
updateChartVisibility(savedType);

document.querySelectorAll('input[name="chartType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        const type = e.target.value;
        localStorage.setItem(chartTypeKey, type);
        updateChartVisibility(type);
    });
});
</script>
{% endblock %}
