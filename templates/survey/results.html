{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ survey.title }}{% endblock %}
{% block content %}
<h1>{{ survey.title }} - {% translate 'Results' %}</h1>
<canvas id="resultsChart"></canvas>
<p class="mt-3">{% translate 'Total respondents' %}: {{ total_users }}</p>
<table class="table">
<thead><tr><th>{% translate 'Question' %}</th><th>{% translate 'Yes' %}</th><th>{% translate 'No' %}</th><th>{% translate 'Total' %}</th></tr></thead>
<tbody>
{% for row in data %}
<tr><td>{{ row.question.text }}</td><td>{{ row.yes }}</td><td>{{ row.no }}</td><td>{{ row.total }}</td></tr>
{% endfor %}
</tbody>
</table>
{% endblock %}
{% block scripts %}
<script>
const data = {
    labels: [{% for row in data %}'{{ row.question.text|escapejs }}',{% endfor %}],
    datasets: [
        {label: '{{ yes_label|escapejs }}', data: [{% for row in data %}{{ row.yes }},{% endfor %}], backgroundColor: 'green'},
        {label: '{{ no_label|escapejs }}', data: [{% for row in data %}{{ row.no }},{% endfor %}], backgroundColor: 'red'}
    ]
};
// Adjust bar height to be slightly larger than the line height of the text
const chartEl = document.getElementById('resultsChart');
const lineHeight = parseFloat(getComputedStyle(document.body).lineHeight);
const barHeight = Math.ceil(lineHeight * 1.2);
chartEl.height = barHeight * data.labels.length;
data.datasets.forEach(ds => ds.barThickness = barHeight);
new Chart(chartEl, {
    type: 'bar',
    data: data,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: { stacked: true, max: {{ total_users }} },
            y: { stacked: true }
        },
        plugins: {
            legend: { display: true }
        }
    }
});
</script>
{% endblock %}
